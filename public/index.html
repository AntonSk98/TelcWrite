<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Klar</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Klar">
    <link rel="apple-touch-icon" href="/icons/icon-192.svg">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/styles.css">
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
</head>

<body>
    <div class="container py-3 py-md-5 main-content"
         x-data="initToasts()"
         @show-toast.window="showToast($event.detail.message, $event.detail.type)">

        <!-- Full-page loading overlay -->
        <div class="global-loader" x-data="{ loading: false }"
             @global-loading.window="loading = $event.detail.show"
             x-show="loading" x-transition.opacity>
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-secondary mt-2 mb-0 small">Übung wird erstellt...</p>
        </div>

        <!-- Header -->
        <header class="text-center mb-3 mb-md-4">
            <div class="d-flex align-items-center justify-content-center gap-2 mb-1">
                <div class="logo d-flex align-items-center justify-content-center rounded-3 text-white fs-5">
                    <i class="bi bi-feather"></i>
                </div>
                <h1 class="h3 h2-md fw-bold mb-0">Klar</h1>
            </div>
            <p class="text-secondary mb-0 small">Deutsch schreiben, besser werden.</p>
        </header>

        <!-- Create Exercise (HTMX partial) -->
        <div hx-get="/partials/create-exercise" hx-trigger="load" hx-swap="innerHTML"></div>

        <!-- Text List + Pagination (HTMX partial) -->
        <div id="text-list" hx-get="/partials/text-list" hx-trigger="load, refreshList from:body" hx-swap="innerHTML">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-secondary mt-2 mb-0 small">Laden...</p>
            </div>
        </div>

        <!-- Toast -->
        <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1050">
            <div :class="toast.css" x-text="toast.message" x-show="toast.message" x-transition.opacity></div>
        </div>

        <!-- Action Buttons (Alpine.js - needs client-side JS for PDF/DB operations) -->
        <div hx-get="/partials/action-buttons" hx-trigger="load" hx-swap="innerHTML"></div>
    </div>

    <script>
        function initToasts() {
            return {
                toast: { message: '', css: '' },

                showToast(message, type) {
                    this.toast = { message, css: `alert alert-${type} py-2 px-3 shadow-sm` };
                    setTimeout(() => { this.toast = { message: '', css: '' }; }, 3000);
                }
            };
        }

        // Listen for HTMX events to show toasts
        document.addEventListener('htmx:responseError', () => {
            window.dispatchEvent(new CustomEvent('show-toast', {
                detail: { message: 'Etwas ist schiefgelaufen', type: 'danger' }
            }));
        });

        // Listen for custom HX-Trigger toast events
        document.addEventListener('showToast', (e) => {
            const { message, type } = e.detail;
            window.dispatchEvent(new CustomEvent('show-toast', {
                detail: { message, type }
            }));
        });

        // HTMX-triggered events from server HX-Trigger headers
        document.addEventListener('documentCreated', () => {
            window.dispatchEvent(new CustomEvent('show-toast', {
                detail: { message: 'Aufsatz erstellt!', type: 'success' }
            }));
        });

        document.addEventListener('documentDeleted', () => {
            window.dispatchEvent(new CustomEvent('show-toast', {
                detail: { message: 'Gelöscht', type: 'success' }
            }));
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then((reg) => console.log('✅ PWA Service Worker registered'))
                .catch((err) => console.warn('PWA registration failed:', err));
        }
    </script>
</body>

</html>