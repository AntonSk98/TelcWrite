<!-- Create Exercise Component -->
<div class="card border-0 shadow-sm rounded-3 mb-3" x-data="createExercise()">
    <div class="card-body p-3 p-md-4">
        <label class="form-label small text-uppercase text-secondary fw-semibold">Neue Übung</label>
        <form class="create-form"
              hx-post="/api/documents"
              hx-swap="none"
              hx-on::after-request="if(event.detail.successful) this.reset()">
            <input type="text" name="title" class="form-control bg-light border-0 flex-grow-1" placeholder="Titel" required>
            <button type="submit" class="btn btn-primary px-3" title="Manuell erstellen">
                <i class="bi bi-plus-lg"></i>
            </button>
            <button type="button" class="btn btn-primary px-3" @click="generate($el.closest('form').querySelector('[name=title]'))" title="KI-Übung generieren">
                <i class="bi bi-stars"></i>
            </button>
        </form>
    </div>
</div>

<script>
function createExercise() {
    return {
        async generate(input) {
            this.$dispatch('global-loading', { show: true });
            const instructions = input.value.trim();

            try {
                const res = await fetch('/api/exercises/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(instructions ? { instructions } : {}),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || 'Generation failed');
                }
                const { documentId } = await res.json();
                window.location.href = `/doc/${documentId}`;
            } catch (error) {
                console.error('Exercise generation error:', error);
                this.$dispatch('global-loading', { show: false });
                this.$dispatch('show-toast', {
                    message: error.message || 'Übung konnte nicht erstellt werden',
                    type: 'danger'
                });
            }
        }
    };
}
</script>
