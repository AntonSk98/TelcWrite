<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title><%= filename %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
</head>

<body>
  <!-- Server-injected document content (parsed by Alpine on init) -->
  <script id="initial-data" type="application/json"><%- contentJson.replace(/<\//g, '<\\/') %></script>

  <div class="container py-3 py-md-5 main-content" x-data="documentEditor()">

    <!-- Header -->
    <header class="d-flex align-items-center justify-content-between mb-3 mb-md-4 pb-3 border-bottom gap-2">
      <div class="overflow-hidden">
        <small class="text-secondary"><%= creationDate %></small>
        <h1 class="h4 h3-md fw-bold mb-0 text-truncate"><%= filename %></h1>
      </div>
      <a href="/" class="btn btn-light btn-sm d-flex align-items-center gap-1 flex-shrink-0">
        <i class="bi bi-arrow-left"></i>
        <span class="d-none d-sm-inline">Zurück</span>
      </a>
    </header>

    <!-- Task Section -->
    <div class="card border-0 shadow-sm rounded-3 mb-3">
      <div class="card-header bg-transparent border-0 py-3">
        <button class="btn p-0 w-100 text-start d-flex justify-content-between align-items-center"
          data-bs-toggle="collapse" data-bs-target="#taskCollapse" aria-expanded="true">
          <span class="small text-uppercase text-secondary fw-semibold">TELC Aufgabe</span>
          <i class="bi bi-chevron-down text-secondary"></i>
        </button>
      </div>
      <div id="taskCollapse" class="collapse show">
        <div class="card-body pt-0">
          <textarea class="form-control bg-light border-0"
            x-model="task"
            @input="autosave()"
            :disabled="reviewing || hasReview"
            placeholder="Fügen Sie hier die Aufgabenstellung ein (z.B. E-Mail an einen Freund schreiben)..."
            rows="6"></textarea>
        </div>
      </div>
    </div>

    <!-- Content Section -->
    <div class="card border-0 shadow-sm rounded-3 mb-3">
      <div class="card-header bg-transparent border-0 py-3">
        <button class="btn p-0 w-100 text-start d-flex justify-content-between align-items-center"
          data-bs-toggle="collapse" data-bs-target="#contentCollapse" aria-expanded="true">
          <span class="small text-uppercase text-secondary fw-semibold">Ihre Antwort</span>
          <i class="bi bi-chevron-down text-secondary"></i>
        </button>
      </div>
      <div id="contentCollapse" class="collapse show">
        <div class="card-body pt-0">
          <textarea class="form-control bg-light border-0"
            x-model="submissionText"
            @input="autosave()"
            :disabled="reviewing || hasReview"
            placeholder="Schreiben Sie hier Ihren Text (E-Mail, Brief, etc.)..."
            rows="10"></textarea>
          <small class="text-secondary fw-normal pt-2" x-text="wordCount"></small>
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="text-center mb-3 mb-md-4">
      <button class="btn btn-primary w-100 py-2" style="max-width: 400px;"
        :disabled="!canSubmit"
        @click="submitReview()">
        <span x-show="reviewing"><span class="loader"></span> Bitte warten...</span>
        <span x-show="!reviewing && hasReview"><i class="bi bi-arrow-clockwise me-2"></i>Erneut korrigieren</span>
        <span x-show="!reviewing && !hasReview"><i class="bi bi-send me-2"></i>Text korrigieren lassen</span>
      </button>
    </div>

    <!-- Review Section -->
    <div class="card border-0 shadow-sm rounded-3" x-show="hasReview && !reviewing" x-transition>
      <div class="card-body p-3 p-md-4">

        <!-- Score -->
        <div class="text-center py-4 border-bottom mb-4">
          <div class="score-display fw-bold">
            <span x-text="reviewScore"></span><span class="fs-5 text-secondary fw-normal">/45</span>
          </div>
          <p class="text-secondary mb-0 mt-1">Bewertung</p>
        </div>

        <!-- Feedback -->
        <div class="mb-4">
          <label class="small text-uppercase text-secondary fw-semibold d-block mb-2">Feedback</label>
          <div class="p-3 bg-light rounded-3">
            <p class="mb-0" x-text="reviewFeedback"></p>
          </div>
        </div>

        <!-- Correction -->
        <div>
          <label class="small text-uppercase text-secondary fw-semibold d-block mb-2">Korrigierter Text</label>
          <small class="text-secondary d-block mt-2 mb-1">
            <i class="bi bi-pencil me-1"></i>Klicken Sie auf den Text zum Bearbeiten
          </small>
          <div x-show="!showEditable"
            @click="toggleEditable()"
            x-html="renderDiff(correction)"
            class="p-3 bg-light rounded-3"
            style="cursor: pointer; min-height: 100px; line-height: 1.8;"></div>
          <textarea x-show="showEditable"
            x-ref="editableCorrection"
            x-model="correction"
            @blur="onCorrectionBlur()"
            @input="autosave()"
            class="form-control bg-light border-0 mt-2" rows="10"></textarea>
        </div>

      </div>
    </div>

  </div>

  <script>
    function documentEditor() {
      const initial = JSON.parse(document.getElementById('initial-data')?.textContent || '{}');

      return {
        documentId: '<%= documentId %>',
        task: initial.task || '',
        submissionText: initial.submissionText || '',
        reviewScore: initial.reviewScore ?? null,
        reviewFeedback: initial.reviewFeedback || '',
        correction: initial.correction || '',
        reviewing: false,
        showEditable: false,
        _saveTimeout: null,

        get wordCount() {
          return this.submissionText.trim().split(/\s+/).filter(w => w.length > 0).length;
        },

        get hasReview() {
          return this.reviewScore !== null && !!this.reviewFeedback && !!this.correction;
        },

        get canSubmit() {
          if (this.reviewing) return false;
          if (this.hasReview) return true;
          return this.wordCount >= 100;
        },

        autosave() {
          clearTimeout(this._saveTimeout);
          this._saveTimeout = setTimeout(() => {
            fetch(`/api/data/${this.documentId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                task: this.task,
                submissionText: this.submissionText,
                reviewScore: this.reviewScore,
                reviewFeedback: this.reviewFeedback,
                correction: this.correction
              })
            });
          }, 500);
        },

        async submitReview() {
          if (this.reviewing) return;
          this.reviewing = true;

          try {
            const res = await fetch(`/api/content/review/${this.documentId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            if (!res.ok) throw new Error('Review failed');

            // Fetch updated content with review results
            const dataRes = await fetch(`/api/data/${this.documentId}`);
            const { content } = await dataRes.json();
            this.reviewScore = content.reviewScore;
            this.reviewFeedback = content.reviewFeedback;
            this.correction = content.correction;
          } catch (error) {
            console.error('Review error:', error);
            alert('Fehler bei der Korrektur. Bitte versuchen Sie es erneut.');
          } finally {
            this.reviewing = false;
            if (this.hasReview) {
              this.$nextTick(() => {
                document.querySelector('.score-display')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
              });
            }
          }
        },

        renderDiff(text) {
          if (!text) return '';
          let escaped = text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\n/g, '<br>');

          const html = escaped.replace(/--(.*?)--|\+\+(.*?)\+\+/g, (_, removed, added) => {
            if (removed !== undefined) return `<span class="bg-removed px-1 rounded">${removed}</span>`;
            if (added !== undefined) return `<span class="bg-added px-1 rounded">${added}</span>`;
            return '';
          });

          return DOMPurify.sanitize(html, {
            ALLOWED_TAGS: ['span', 'br'],
            ALLOWED_ATTR: ['class']
          });
        },

        toggleEditable() {
          this.showEditable = true;
          this.$nextTick(() => this.$refs.editableCorrection?.focus({ preventScroll: true }));
        },

        onCorrectionBlur() {
          setTimeout(() => { this.showEditable = false; }, 200);
        }
      };
    }
  </script>
</body>

</html>
